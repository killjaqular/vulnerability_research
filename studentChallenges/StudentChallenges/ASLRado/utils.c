//
// Created by linus on 11/7/20.
//

#include<stdlib.h>
#include<stdio.h>
#include<time.h>
#include<math.h>
#include<ctf.h>
#include"defines.h"
#include <pwd.h>

#ifdef __cplusplus
#include<iostream>
#endif



unsigned int GetSession(){
    unsigned int session = time(NULL);
    return session;
}


char* GetSessionStr(unsigned int session){
//    int session_len = (int)((ceil(log10(session))+1)*sizeof(char));
    unsigned int session_len = 32;

    char* sessionstr = malloc(session_len);
    sprintf(sessionstr, "%d", session);
    return sessionstr;

}



char* GetUsername(){
    char* loginid = malloc(BUFSIZE);

    printf("login: ");
    ctf_readsn(STDIN_FILENO, loginid, BUFSIZE);
    return loginid;
}

void getflag(char loginid[], char Stage[])
{
    struct passwd *pwentry;
    char path[BUFSIZE];
    char flag[BUFSIZE];
    int fd = 0;

    path[0] = '\0';
    memset(path, 0, BUFSIZE);
    memset(flag, 0, BUFSIZE);

#ifdef DEBUG
    ctf_writes(STDOUT_FILENO, "Success!!\n");
#endif

    // figure out where the flag is stored for this service
    pwentry = getpwuid(geteuid());
    if (!pwentry) {
        ctf_writes(STDOUT_FILENO, "Warning: Could not find user. Using current directory.\n");
        getcwd(path, BUFSIZE/2);
    } else {
        strncpy(path, pwentry->pw_dir, BUFSIZE/2);
    }

#ifdef DEBUG
    getcwd(path, BUFSIZE/2);
    printf("%s", loginid);
    ctf_writes(STDOUT_FILENO, "\n");
    ctf_writes(STDOUT_FILENO, Stage);
    ctf_writes(STDOUT_FILENO, "\n");
#endif

    strncat(path, "/flags/", BUFSIZE/2);
    strncat(path, loginid, BUFSIZE/2);

    if(strcmp(Stage, "") != 0){
        strncat(path, "-", BUFSIZE/2);
        strncat(path, Stage, BUFSIZE/2);
    }

#ifdef DEBUG
    ctf_writes(STDOUT_FILENO, path);
    ctf_writes(STDOUT_FILENO, "\n");
#endif

    // read the flag and give it to the user
    fd = open(path, O_RDONLY);
    ctf_readsn(fd, flag, BUFSIZE);
    close(fd);
    ctf_writef(STDOUT_FILENO, "Congratulations!\n");
    ctf_writef(STDOUT_FILENO, "%s\n", flag);

    return;
}


unsigned int randomnum(unsigned int min, unsigned int max){
    return min + rand() / (RAND_MAX / (max - min + 1) + 1);
}
