#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>

int win(void){
    // 0x565562ad
    printf("You win!\n");
    exit(EXIT_SUCCESS);
}

void lose(void){
    // 0x565562df
    printf("Whomp whomp :(\n");
    exit(EXIT_FAILURE);
}

struct record{
    uint32_t record_id;   // 4bytes
    char name[80];        // 80bytes
    char description[80]; // 80bytes
};

typedef void (*fnptr)(void);

void print_line(char c, size_t len){
    printf(" ");
    for (size_t i = 0; i < (len - 2); ++i) {
        putchar(c);
    }
    printf("\n");
}

void print_msg_box_line(const char *msg, size_t width){
    size_t msglen = strlen(msg);
    size_t chars_left = width - 2; // For |'s  
    size_t spaces_per_side = (chars_left - msglen) / 2;
    printf("|");
    for (size_t i = 0; i < spaces_per_side; ++i) {
        printf(" ");
    }
    printf("%s", msg);
    if (msglen % 2 != 0) {
        spaces_per_side++;
    }
    for (size_t i = 0; i < spaces_per_side; ++i) {
        printf(" ");
    }
    printf("|\n");
}

void print_header(void){
    print_line('=', 80);
    print_msg_box_line("", 80);
    print_msg_box_line("", 80);
    print_msg_box_line("WELCOME TO THE PWN U RECORD KEEPER", 80);
    print_msg_box_line("Please choose your selection:", 80);
    print_msg_box_line("", 80);
    print_msg_box_line("", 80);
    print_line('=', 80);
}

void print_menu(void){
    printf("1. Enter a record\n");
    printf("2. Retrieve a record\n");
    printf("3. Print all records\n");
    printf("4. Quit\n");
}

#define INVALID_CHOICE ((uint32_t)-1)

uint32_t read_u32(void){
    char buf[80] = {0};
    fgets(buf, 80, stdin);
    return (uint32_t)strtoul(buf, NULL, 0);
}

uint32_t get_choice(void){
    errno = 0;
    uint32_t choice = read_u32();
    if (errno != 0) {
        return INVALID_CHOICE;
    }

    if (choice < 1 || choice > 4) {
        return INVALID_CHOICE;
    }
    return choice;
}

void save_record(struct record *records){
    printf("Which record do you want to save to?\n");
    uint32_t recordnum = read_u32();
    struct record *r = &records[recordnum];
    printf("Enter the record ID:\n");
    r->record_id = read_u32();
    printf("Enter a name (80 chars max):\n");
    fgets(r->name, 80, stdin);
    printf("Enter a description (80 chars max)\n");
    fgets(r->description, 80, stdin);
}

void retrieve_record(struct record *records){
    printf("Which record do you want to retrieve?\n");
    uint32_t recordnum = read_u32();
    struct record *r = &records[recordnum];
    printf("Record ID: %u\n", r->record_id);
    printf("Record Name: %s\n", r->name);
    printf("Record Description: %s\n", r->description);
}

void print_all_records(struct record *records){
    for (size_t i = 0; i < 10; ++i) {
        struct record *r = &records[i];
        printf("Record ID: %u\n", r->record_id);
        printf("Record Name: %s\n", r->name);
        printf("Record Description: %s\n", r->description);
    }
}

int main(void){
    volatile fnptr fp = lose;  // 4bytes
    // address of lose - 32 = address of win
    struct record records[10]; // 1640bytes
    // stack size: 1644bytes
    bzero(records, sizeof(records));

    print_header();
    while (true) {
        print_menu();
        uint32_t choice = get_choice();
        switch(choice) {
            case 1:
                save_record(&records[0]);
                break;
            case 2:
                retrieve_record(&records[0]);
                break;
            case 3:
                print_all_records(&records[0]);
                break;
            case 4:
                printf("Goodbye!\n");
                exit(0);
            default: 
                printf("Invalid input!\n");
                fp();
                break;
        }
    }
}
